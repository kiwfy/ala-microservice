<?php

namespace Tests\Feature\Domains\{{domainCaps}};

use DatabaseCache\Repository;
use Laravel\Lumen\Testing\DatabaseMigrations;
use Mockery;
use Tests\Feature\TestCaseFeature;

class {{domainCaps}}DetailControllerTest extends TestCaseFeature
{
    use DatabaseMigrations;

    protected function setUp(): void
    {
        parent::setUp();
        $this->artisan('db:seed', ['--class' => '{{domainCaps}}']);
    }

    /**
     * @covers \App\Domains\{{domainCaps}}\Http\Controllers\{{domainCaps}}DetailController::__construct
     * @covers \App\Domains\{{domainCaps}}\Http\Controllers\{{domainCaps}}DetailController::process
     * @covers \App\Domains\{{domainCaps}}\Businesses\{{domainCaps}}DetailBusiness::__construct
     * @covers \App\Domains\{{domainCaps}}\Businesses\{{domainCaps}}DetailBusiness::process
     */
    public function testDetail()
    {
        $repositoryeMock = Mockery::mock('overload:' . Repository::class);
        $repositoryeMock->shouldReceive('getQuery')
            ->once()
            ->andReturn(null)
            ->shouldReceive('setQuery')
            ->once()
            ->andReturn(true);

        $this->json('GET', '/{{domainOriginal}}/detail/' . $this->id, [], $this->header);

        $response = json_decode($this->response->getContent(), true);

        $this->assertEquals(200, $this->response->getStatusCode());
        $this->assertNotNull($response['data']['field']);
    }

    /**
     * @covers \App\Domains\{{domainCaps}}\Http\Controllers\{{domainCaps}}DetailController::__construct
     * @covers \App\Domains\{{domainCaps}}\Http\Controllers\{{domainCaps}}DetailController::process
     * @covers \App\Domains\{{domainCaps}}\Businesses\{{domainCaps}}DetailBusiness::__construct
     * @covers \App\Domains\{{domainCaps}}\Businesses\{{domainCaps}}DetailBusiness::process
     */
    public function testDetailCache()
    {
        $result = [
            'field' => 'test',
        ];

        $repositoryeMock = Mockery::mock('overload:' . Repository::class);
        $repositoryeMock->shouldReceive('getQuery')
            ->once()
            ->andReturn(json_encode($result))
            ->shouldReceive('setQuery')
            ->never()
            ->andReturn(true);

        $this->json('GET', '/{{domainOriginal}}/detail/' . $this->id, [], $this->header);

        $response = json_decode($this->response->getContent(), true);

        $this->assertEquals(200, $this->response->getStatusCode());
        $this->assertEquals($result['field'], $response['data']['field']);
    }

    /**
     * @covers \App\Domains\{{domainCaps}}\Http\Controllers\{{domainCaps}}DetailController::__construct
     */
    public function testDetailIdInvalid()
    {
        $this->json('GET', '/{{domainOriginal}}/detail/123', [], $this->header);

        $response = json_decode($this->response->getContent(), true);

        $this->assertEquals(404, $this->response->getStatusCode());
        $this->assertEquals('Route not found', $response['message']);
    }

    /**
     * @covers \App\Domains\{{domainCaps}}\Http\Controllers\{{domainCaps}}DetailController::__construct
     * @covers \App\Domains\{{domainCaps}}\Http\Controllers\{{domainCaps}}DetailController::process
     * @covers \App\Domains\{{domainCaps}}\Businesses\{{domainCaps}}DetailBusiness::__construct
     * @covers \App\Domains\{{domainCaps}}\Businesses\{{domainCaps}}DetailBusiness::process
     */
    public function testDetailNotFound()
    {
        $repositoryeMock = Mockery::mock('overload:' . Repository::class);
        $repositoryeMock->shouldReceive('getQuery')
            ->once()
            ->andReturn(null)
            ->shouldReceive('setQuery')
            ->never()
            ->andReturn(true);

        $this->json('GET', '/{{domainOriginal}}/detail/01E492KQX6BW62YEA45SGWRXYQ', [], $this->header);

        $response = json_decode($this->response->getContent(), true);

        $this->assertEquals(404, $this->response->getStatusCode());
        $this->assertEquals('Data not found', $response['message']);
    }
}
